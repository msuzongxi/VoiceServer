<html xmlns:th="http://www.thymeleaf.org" class="JFEScope" lang="EN">
  <head>
    <title>Task 1: Video Recording</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="/stylesheet.css" rel="stylesheet">
    <script src="../jquery2.1.4.min.js"></script>

    <style>
      :root{
        --gap: 16px;
        --videoW: min(480px, 100%);
      }

      #Progress_Status {
        width: var(--videoW);
        background-color: #ddd;
        margin-bottom: 10px;
      }
      #myprogressBar {
        width: 0%;
        height: 25px;
        background-color: #4CAF50;
        text-align: center;
        line-height: 25px;
        color: black;
      }

      .video-box video {
        display: block;
        width: var(--videoW);
        max-width: 100%;
        border: 1px solid black;
        background: #000;
        aspect-ratio: 16 / 9;
        height: auto;
      }

      .row-label { margin-top: 8px; }

      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
        align-items: start;
      }

      .buttons-two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
        align-items: start;
      }

      @media (max-width: 820px) {
        .two-col { grid-template-columns: 1fr; }
        .buttons-two-col { grid-template-columns: 1fr; }
        #Progress_Status { width: 100%; }
        :root { --gap: 12px; }
      }
    </style>
  </head>

  <body>
  <div class="Skin">
      <div th:if="${session.test == 'y'}">
        <div>Welcome, [[${session.uuid}]]</div>
      </div>

    <div id="SkinContent">
      <div id="LogoBar"><div id="Logo"><h1>Task 1: Video Recording</h1></div></div>

      <p class="QuestionText">
        The goal of this task is to collect your biometric features (e.g., phonation, pitch, rate, etc.) to be used as inputs for music recommender systems.
        <br/><br/>Imagine that you are chatting with a friend and he/she asks you the following question:
      </p>
      <p class="QuestionText"><font size=3><strong>&nbsp;&nbsp;&nbsp;&nbsp;[[${question}]]</strong></font></p>
      </br>
      <p class="QuestionText">
        There are no right or wrong answers. Please click on <strong>Start Recording</strong> and provide your response for up to
        <strong><span id="maxSecondsLabel">30</span> seconds</strong>.
      </p>
      <p class="QuestionText">You may click on <strong>Stop Recording</strong> when you finish your response and review your recording on the right.</p>
      <p class="QuestionText">In case you want to record a different response, you may click on the <strong>Reload Page</strong> button to restart.</p>
      <br/><br/>

      <div id="Progress_Status">
        <div id="myprogressBar">0s</div>
      </div>

      <div class="two-col">
        <div class="video-box">
          <video id="preview" autoplay muted playsinline></video>
          <div class="row-label">Live Recording</div>
        </div>

        <div class="video-box">
          <video id="playbackVideo" controls preload="metadata"></video>
          <div class="row-label">Recorded Playback</div>
        </div>
      </div>

      <div class="buttons-two-col" style="margin-top: 12px;">
        <div class="btn-row">
          <button id="startBtn">Start Recording</button>
          <button id="stopBtn" disabled>Stop Recording</button>
        </div>

        <div class="btn-row">
          <button id="playBtn" disabled>Play Recording</button>
          <button id="Reload" onclick="location.reload()">Reload Page</button>
          <button id="uploadBtn" disabled>Upload</button>
        </div>
      </div>

      <br/>
		<!-- Upload status messages -->
		<div id="uploadMsg" class="alert" style="display:none; margin-top:12px;font-size:1.2rem;"></div>

      <div id="Buttons" role="navigation">
        <input id="NextButton" disabled style="width:12vw;height:3vw" class="NextButton Button"
               title=" → " type="button" name="NextButton" value="Next → ">
      </div>
    </div>
  </div>

<script th:inline="javascript">
  // jQuery-based + more browser tolerant:
  // - Uses $.ajax for upload (avoids fetch issues on older browsers)
  // - Tries a list of MediaRecorder mimeTypes for better compatibility
  // - Uses a time-slice so dataavailable fires periodically (more robust)
  // - Falls back to <video srcObject> assignment that works in older browsers

  $(function () {
    // ===== Config =====
    var MAX_SECONDS = 30;
    var TICK_MS = 100;
    $("#maxSecondsLabel").text(String(MAX_SECONDS));

    var uuid = [[${session.uuid}]];

    // ===== State =====
    var mediaRecorder = null;
    var recordedChunks = [];
    var streamRef = null;

    var timerId = null;
    var elapsed = 0;

    // jQuery elements
    var $startBtn = $("#startBtn");
    var $stopBtn = $("#stopBtn");
    var $uploadBtn = $("#uploadBtn");
    var $playBtn = $("#playBtn");
    var $nextBtn = $("#NextButton");

    var $progressBar = $("#myprogressBar");

    var previewEl = document.getElementById("preview");
    var playbackEl = document.getElementById("playbackVideo");

    function setProgress(seconds) {
      var pct = Math.min(100, (seconds / MAX_SECONDS) * 100);
      $progressBar.css("width", pct + "%").text(Math.floor(seconds) + "s");
    }
    
    function showMsg(type, text) {
    	  // type: "success" | "danger" | "info" | "warning"
    	  $("#uploadMsg")
    	    .removeClass("alert-success alert-danger alert-info alert-warning")
    	    .addClass("alert-" + type)
    	    .html(text)
    	    .show();
    }

    function resetProgress() {
      elapsed = 0;
      setProgress(0);
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
    }

    function startTimer() {
      stopTimer();
      timerId = setInterval(function () {
        elapsed += TICK_MS / 1000;
        setProgress(elapsed);

        if (elapsed >= MAX_SECONDS) {
          stopTimer();
          // hard stop at MAX_SECONDS
          if (mediaRecorder && mediaRecorder.state === "recording") {
            mediaRecorder.stop();
            $stopBtn.prop("disabled", true);
            $startBtn.prop("disabled", false);
          }
        }
      }, TICK_MS);
    }

    function stopTracks() {
      if (streamRef && streamRef.getTracks) {
        try {
          streamRef.getTracks().forEach(function (t) { t.stop(); });
        } catch (e) {}
      }
      streamRef = null;
    }

    function setVideoSrcObject(videoEl, stream) {
      // Better compatibility for older browsers
      if ("srcObject" in videoEl) {
        videoEl.srcObject = stream;
      } else {
        // Deprecated but some older browsers used it
        videoEl.src = window.URL.createObjectURL(stream);
      }
      videoEl.play && videoEl.play().catch && videoEl.play().catch(function(){});
    }

    function chooseMimeType() {
      // Safari historically lacks MediaRecorder; Chrome/Edge support webm; some support mp4
      var candidates = [
        "video/webm;codecs=vp9,opus",
        "video/webm;codecs=vp8,opus",
        "video/webm",
        "video/mp4" // only if supported by browser MediaRecorder
      ];

      if (!window.MediaRecorder || !MediaRecorder.isTypeSupported) return "";
      for (var i = 0; i < candidates.length; i++) {
        if (MediaRecorder.isTypeSupported(candidates[i])) return candidates[i];
      }
      return "";
    }

    function buildRecorder(stream) {
      var mimeType = chooseMimeType();
      var options = {};

      if (mimeType) options.mimeType = mimeType;

      // Lower bitrates can improve upload success; adjust if needed
      // options.videoBitsPerSecond = 600000;
      // options.audioBitsPerSecond = 64000;

      try {
        return new MediaRecorder(stream, options);
      } catch (e) {
        // fallback without options
        return new MediaRecorder(stream);
      }
    }

    function updatePlaybackFromChunks() {
      if (!recordedChunks.length) return;

      var blobType = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : "video/webm";
      var blob = new Blob(recordedChunks, { type: blobType });
      var url = window.URL.createObjectURL(blob);

      playbackEl.pause();
      playbackEl.removeAttribute("src");
      playbackEl.load();

      playbackEl.src = url;
      playbackEl.load();

      $playBtn.prop("disabled", false);
      $uploadBtn.prop("disabled", false);
    }

    function initCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Your browser does not support camera recording. Please use a modern Chrome/Edge browser.");
        return;
      }

      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(function (stream) {
          streamRef = stream;
          setVideoSrcObject(previewEl, stream);

          if (!window.MediaRecorder) {
            alert("MediaRecorder is not supported in this browser. Please use Chrome/Edge. (Safari needs a different approach.)");
            return;
          }

          mediaRecorder = buildRecorder(stream);

          // Use timeslice so we get periodic dataavailable events (more robust)
          // Some browsers only fire dataavailable at stop; timeslice helps.
          mediaRecorder.ondataavailable = function (event) {
            if (event.data && event.data.size > 0) recordedChunks.push(event.data);
          };

          mediaRecorder.onstop = function () {
            stopTimer();
            updatePlaybackFromChunks();
          };
        })
        .catch(function (err) {
          alert("Error accessing camera/mic: " + err);
        });
    }

    initCamera();

    $startBtn.on("click", function () {
      if (!mediaRecorder) {
        alert("Recorder not ready yet.");
        return;
      }
      if (mediaRecorder.state === "recording") return;

      recordedChunks = [];
      resetProgress();

      $uploadBtn.prop("disabled", true);
      $playBtn.prop("disabled", true);
      $nextBtn.prop("disabled", true);

      // clear playback
      playbackEl.pause();
      playbackEl.removeAttribute("src");
      playbackEl.load();

      try {
        // Pass timeslice (ms) for better cross-browser behavior
        mediaRecorder.start(1000);
      } catch (e) {
        try { mediaRecorder.start(); } catch (e2) {
          alert("Failed to start recording: " + e2);
          return;
        }
      }

      startTimer();

      $startBtn.prop("disabled", true);
      $stopBtn.prop("disabled", false);
    });

    $stopBtn.on("click", function () {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
      $startBtn.prop("disabled", false);
      $stopBtn.prop("disabled", true);
    });

    $playBtn.on("click", function () {
      playbackEl.play && playbackEl.play().catch && playbackEl.play().catch(function(){});
    });
    
    $nextBtn.on("click", function () {
    	location.href = "/videoRecordNext";        
    });

    $("#uploadBtn").on("click", function () {
    	  if (!recordedChunks.length) {
    	    showMsg("warning", "No recording found. Please record your video first.");
    	    return;
    	  }

    	  var type = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : "video/webm";
    	  var blob = new Blob(recordedChunks, { type: type });

    	  var fd = new FormData();
    	  fd.append("file", blob, (uuid ? (uuid + ".webm") : "recording.webm"));
    	  fd.append("rid", uuid);

    	  // UI state
    	  $("#uploadBtn").prop("disabled", true);
    	  showMsg("info", "Uploading... please wait.");

    	  $.ajax({
    	    url: "/video/upload",
    	    type: "POST",
    	    data: fd,
    	    processData: false,
    	    contentType: false,
    	    timeout: 180000, // 3 minutes
    	    success: function (respText) {
    	      // Enable Next + show a friendly in-page message
    	      $("#NextButton").prop("disabled", false);

    	      showMsg(
    	        "success",
    	        "✅ Upload successful. You may now click <strong>Next</strong> to proceed to the next step."
    	      );
    	      
    	    },
    	    error: function (xhr) {
    	      $("#uploadBtn").prop("disabled", false);

    	      var msg = (xhr && xhr.responseText) ? xhr.responseText : ("HTTP " + (xhr ? xhr.status : ""));
    	      showMsg("danger", "❌ Upload failed: " + $("<div/>").text(msg).html());
    	    }
    	  });
    	});
    $(window).on("beforeunload", function () {
      stopTimer();
      stopTracks();
    });
  });
</script>
  </body>
</html>
